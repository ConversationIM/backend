<html>

<head>
  <style>
    html {
      margin: 20px;
    }

    p {
      margin-top: 0px;
      margin-bottom: 0px;
    }
  </style>
</head>

<body>
  <h1>Status</h1>
  <div>
    <p id="status">Connecting...</p>
  </div>
  <form id="authForm" style="display:none">
    <input id="jwt" placeholder="Authentication Token" autocomplete="off">
    <button>Set Authentication</button>
  </form>
  <button id="createConvo" style="display:none">Create Room</button>
  <form id="messageForm" style="display:none">
    <input id="message" autocomplete="off" />
    <button>Send</button>
  </form>
  <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script type="text/javascript" charset="utf-8">
    var statusElement = document.getElementById("status");
    var tipElement = document.getElementById("tip");
    var authFormElement = document.getElementById("authForm");
    var messageFormElement = document.getElementById("messageForm");

    try {
      // we now have two connections -- one 'global' connection (for app-wide events)
      // and one 'conversation' connection (for conversation-specific events)
      var global = io.connect("http://localhost:5000/global");
      var conversation = io.connect("http://localhost:5000/conversation");
      // the user's raw JWT token
      var token;
      // the payload of the above token
      var payload;
      // the unique ID for this conversation
      var conversationId;

      // just add the error to the status element if one comes up
      var errorHandler = function(error) {
        statusElement.innerHTML += "<p style='color:red'> - Error: " + error + "</p>";
      };

      // try to establish both connections
      global.on('connect', function() {
        conversation.on('connect', function() {
          // upon success, alert the user
          statusElement.innerHTML = "<p> - Connected to all namespaces.</p>";

          // the ask for his/her JWT token
          authFormElement.style.display = "";
          $(authFormElement).submit(function(event) {
            event.preventDefault();
            authFormElement.style.display = "none";

            // store the token and payload for later
            token = $("#jwt").val();
            payload = JSON.parse(atob(token.split('.')[1]));

            // initialize both connections (global's initialization MUST come first)
            // or an error will be sent back
            global.emit('initialize', JSON.stringify({
              'token': token
            }), function() {
              conversation.emit('initialize', JSON.stringify({
                'token': token
              }), function() {
                // once both are initialized, we're ready to go
                // so show a button to create a new convo to the user admin@example.com
                if (payload['email'] === 'admin@example.com') {
                  $('#createConvo').show();
                  $('#createConvo').on('click', function(event) {
                    event.preventDefault();

                    // on click, send up a request to the API to create a
                    // new conversation with the participant test@example.com
                    // NOTE: if test@example.com is not online, he/she will not be
                    // added to the conversation!
                    $.ajax({
                      type: "POST",
                      url: "http://localhost:5000/v1/conversation",
                      data: JSON.stringify({
                        "participants": ["test@example.com"]
                      }),
                      contentType: 'application/json; charset=utf-8',
                      dataType: 'json',
                      beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', token);
                      },
                      success: function(response) {
                        // hide the create conversation button on success
                        $('#createConvo').hide();

                        conversationId = response.data.conversationId;
                        statusElement.innerHTML = "<p>You're now chatting with " + response.data.participants + ".</p>";

                        messageFormElement.style.display = "";
                      },
                      error: function(error) {
                        console.log("There was an error: ", error);
                      }
                    });
                  });
                } else {
                  // if the user isn't the specific user that we're allowing to start conversations,
                  // just show a 'waiting' message
                  // NOTE: any user can create conversations in the real app!
                  $(statusElement).append("<p>- Waiting for incoming conversations</p>");
                }
              });
            });
          });
        });
      });

      // alert the client of errors
      global.on('error', errorHandler);
      conversation.on('error', errorHandler);

      // let the user know that he/she has been added to a conversation
      global.on('added', function(data) {
        conversationId = data.conversationId;
        statusElement.innerHTML = "<p>Added to conversation by " + data.creator + ".</p>";
        messageFormElement.style.display = "";
      });

      // show the user what's going on with the conversation on update
      conversation.on('updated', function(data) {
      	statusElement.innerHTML += "<p> - " + data.sender + " is typing: " + data.message + "</p>";
      });
      // show the user when a message was sent (finalized)
      conversation.on('sent', function(data) {
      	statusElement.innerHTML += "<p style='color:green'> - " + data.sender + " sent: " + data.message + "</p>";
      });

      // handle when the user types something
      $('#message').on('keyup', function(event) {
      	var val = $(this).val();
      	if (val.trim() === '') return;
      	conversation.emit('updated', JSON.stringify({'sender': payload.email, 'conversationId': conversationId, 'message': val}));
      });

         // handle when the user sends the message
      $(messageFormElement).submit(function (event) {
           event.preventDefault();
           var val = $('#message').val().trim();
           if (val === "") return false;
           conversation.emit('sent', JSON.stringify({'sender': payload.email, 'conversationId': conversationId, 'message': val}));

           $('#message').val('');
         });
    } catch (e) {
      statusElement.innerHTML = e;
    }
  </script>
</body>

</html>
